name: CI/CD - Build, Push and Deploy Docker Image Application

on:
    push:
        branches: ['main']
    workflow_dispatch:

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ secrets.DOCKERHUB_USERNAME }}/portfolio-sveltekit:latest

    deploy:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Setup SSH Agent
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

            - name: Deploy to VPS
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
                    cd /var/www/brianleft.com/app
                    echo "====> Descargando la nueva imagen desde Docker Hub"
                    docker pull ${{ secrets.DOCKERHUB_USERNAME }}/portfolio-sveltekit:latest
                    echo "====> Reiniciando el contenedor con la nueva imagen"
                    docker compose up -d
                    echo "====> Limpiando imÃ¡genes antiguas"
                    docker image prune -af
                    echo "====> Despliegue completado exitosamente"
                  EOF
